// MAIL SEND
Mailgroup:="TEST_ADMIN";
MailTemplateId:="ALERTDQC";
html:=0;
messagecode:=MailTemplateId;
receiver := BUILD_RECIPIENT_MAIL_LIST(Mailgroup);  
MessageTemplate:= getObjects("MxIssueMessage", "CODE = '"+messagecode+"'");

req:="select FEEDREJECT_ID from FEEDREJECT where reject_type in ( 23648,24109,24108,24111,73272,31362,24110) and reject_date=CONVERT(VARCHAR(10),getdate(),103) and class_id=22"

res:= getSqlData(req);
array_size:=arraysize(res);
SecurityArray:=array();

for (j:=0;j<array_size;j:=j+1)
{
rs:=res[j] // ID
RejectObj:=getobject("MxFeedReject",rs[0])
SecurityRID:=RejectObj.OBJECT_ID;
SReject_reason:=RejectObj.REJECT_REASON;
SecurityObj:=getobject("MxSecurity",SecurityRID)
test:=SecurityObj.SECURITY_CLASS_GROUP[SECURITY_CLASS_TYPE="SEC_CLASS"]  
if (test=443924) 
{   

Security_name:=SecurityObj.NAME
SecurityArray:=arrayappend(SecurityArray,"Incriminated Security : " + Security_name +"\n"+"Reason: "+SReject_reason);
}
else
{
    SecurityArray:=SecurityArray    
 }   
}


if(MessageTemplate[0]!="")
{
  
Messageemail:=MessageTemplate[0]
subject:=Messageemail.REASON[LANGUAGE=1];
messageContent:=Messageemail.MESSAGE[LANGUAGE=1];
subject:=strreplace(subject,"#datej",date());
messageContent:=strreplace(messageContent,"#datej",date());  
messageContent:=strreplace(messageContent,"#insreq",SecurityArray);        
SEND_MAIL_GENERIC_COMPLETE(receiver,subject,messageContent,html);  
}
else
{
  userinfo("pas de template d'email configuré pour cette étape, code du template:"+cookiecode);
}
return "OK";
